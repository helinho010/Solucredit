 #!/bin/bash
################################### Parametros ############################################### 
# Horas que deberia estar disponibles el servidor [min]
hd=600

# 

#Establecer la direccion del servidor a testear
servidor="192.168.2.90"

#rutaArchivoDiagnostico
rarch="/home/ubuntu/Desktop"

# Tiempo para realizar el Ping 
tping=1

# Numeros de paquetes a enviar
numPaquetes=$1
numPaquetes=${numPaquetes:-1}

# Tiempo entre paquetes
tiempoEntrePaquetes=$2
tiempoEntrePaquetes=${tiempoEntrePaquetes:-2}

# Email predeterminado para el envio de la alerta
nombreUsuario="g.apaza007@gmail.com"

################################################################################################


# Funcion que envia un correo electronico o sms a una determinado contacto

function alertaCaida()
{
  curl -n --ssl-reqd --mail-from $nombreUsuario --mail-rcpt "hmejia@solucredit.com.bo" --url smtps://smtp.gmail.com:465 --user "$nombreUsuario:$contrasenia" --upload-file $rarch/mail.txt
}

# funcion que captura  la respuesta del comando ping con un envio ICMP
function capturaPing()
{
  ((numPaquetes=$tping*60))
  resultadoPing=$(ping -q -c $numPaquetes $servidor | grep "packets transmitted") 
  # Paquetes transmitidos
  numeroPaquetesTransmitidos=${resultadoPing%,*ved*}
  numeroPaquetesTransmitidos=${numeroPaquetesTransmitidos%\ *packets transmitted}
  # paquetes recividos
  numeroPaquetesRecividos2=${resultadoPing#*tted,}
  numeroPaquetesRecividos=${numeroPaquetesRecividos2%,*loss*}
  numeroPaquetesRecividos=${numeroPaquetesRecividos%\ *received}
  # paquetes Perdidos
  numeroPaquetesPerdidos2=${resultadoPing#*ved,}
  numeroPaquetesPerdidos=${numeroPaquetesPerdidos2%,*ms}
  numeroPaquetesPerdidos=${numeroPaquetesPerdidos%\ *packet loss}

  echo -e "\n $numeroPaquetesTransmitidos \n"
  echo -e "\n $numeroPaquetesRecividos \n" 
  echo -e "\n $numeroPaquetesPerdidos \n"
}

# Funcion de llenao de archivo email
function armadoArchivoMail()
{
  var=$(capturaPing)
  # Paquetes transmitidos
  numeroPaquetesTransmitidos=${var%,*ved*}
  # paquetes recividos
  numeroPaquetesRecividos2=${var#*tted,}
  numeroPaquetesRecividos=${numeroPaquetesRecividos2%,*loss*}
  # paquetes Perdidos
  numeroPaquetesPerdidos2=${var#*ved,}
  numeroPaquetesPerdidos=${numeroPaquetesPerdidos2%,*ms}

  echo -e "From: 'George' <g.apaza007@gmail.com>" > $rarch/mail.txt
  echo -e "To: 'Helio' <hmejia@solucredit.com.bo>" >> $rarch/mail.txt
  echo -e "Subject: Error-Disponibilidad-del-servidor" >> $rarch/mail.txt
  echo -e "\n $numeroPaquetesTransmitidos \n" >> $rarch/mail.txt
  echo -e "\n $numeroPaquetesRecividos \n" >> $rarch/mail.txt
  echo -e "\n $numeroPaquetesPerdidos \n" >> $rarch/mail.txt

}



  # Tiempo de sondeo en segundos 
  ts=3
 contador=0
 rng=100
 while [ $contador -lt 4 ]
  do
  sleep $ts
  # Variable que mide el rando
  #armadoArchivoMail
  if [[ $rng -lt 100 && $rng -gt 80 ]]
    then
     echo -e "\n \033[0;34m Esta disponible \033[0m \e[1;36m bravo! \033[0m \n"
     echo -e "\n rango: $rng \n "
     echo -e "\n contador: $contador \n "
    else
     echo -e "\n \033[1;33m ya se paso del rango \033[0m \n"
     capturaPing
     break
   # alertaCaida
  fi
 ((contador=$contador+1))
 ((rng=$rng+5))
 done

